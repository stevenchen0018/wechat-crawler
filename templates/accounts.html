{{define "accounts"}}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - 微信公众号爬虫管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/admin.css?v=1.0.0" rel="stylesheet">
</head>
<body>
    {{template "navbar" .}}

    <div class="container-fluid mt-4">
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-2">
                    <i class="bi bi-people me-2"></i>公众号管理
                </h2>
                <p class="text-muted mb-0">管理订阅的微信公众号</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                <i class="bi bi-plus-circle me-2"></i>添加公众号
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="搜索公众号名称...">
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>公众号名称</th>
                                <th>别名</th>
                                <th>FakeID</th>
                                <th>最后文章</th>
                                <th>创建时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="accountList">
                            {{if .Accounts}}
                            {{range .Accounts}}
                            <tr data-id="{{.ID.Hex}}">
                                <td><strong>{{.Name}}</strong></td>
                                <td>{{if .Alias}}{{.Alias}}{{else}}-{{end}}</td>
                                <td><code>{{.FakeID}}</code></td>
                                <td>
                                    {{if .LastArticle}}
                                    <a href="{{.LastArticle}}" target="_blank" class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-link-45deg"></i> 查看
                                    </a>
                                    {{else}}
                                    <span class="text-muted">暂无</span>
                                    {{end}}
                                </td>
                                <td>{{.CreatedAt.Format "2006-01-02 15:04"}}</td>
                                <td>
                                    {{if eq .Status 1}}
                                    <span class="badge bg-success">正常</span>
                                    {{else}}
                                    <span class="badge bg-secondary">禁用</span>
                                    {{end}}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewAccount('{{.ID.Hex}}')">
                                        <i class="bi bi-eye"></i> 查看
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount('{{.ID.Hex}}', '{{.Name}}')">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>
                            {{end}}
                            {{else}}
                            <tr>
                                <td colspan="7" class="text-center py-5">
                                    <i class="bi bi-inbox" style="font-size: 48px; color: var(--gray-300);"></i>
                                    <p class="mt-3 mb-2" style="font-size: 16px; font-weight: 500;">暂无公众号数据</p>
                                    <p class="text-muted mb-4">点击上方"添加公众号"按钮开始订阅</p>
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAccountModal">
                                        <i class="bi bi-plus-circle me-2"></i>立即添加
                                    </button>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加公众号模态框 -->
<div class="modal fade" id="addAccountModal" tabindex="-1" aria-labelledby="addAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAccountModalLabel"><i class="bi bi-plus-circle me-2"></i>添加公众号订阅</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addAccountForm">
                    <div class="mb-3">
                        <label for="accountName" class="form-label">公众号名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="accountName" required
                               placeholder="请输入公众号名称（需要完全匹配）">
                        <div class="form-text">请输入微信公众号的准确名称</div>
                    </div>
                    <div class="mb-3">
                        <label for="accountAlias" class="form-label">别名（可选）</label>
                        <input type="text" class="form-control" id="accountAlias"
                               placeholder="可以为公众号设置一个别名">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitAddAccount()">
                    <i class="bi bi-check-circle me-2"></i>添加
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 搜索功能
document.getElementById('searchInput').addEventListener('input', function(e) {
    const keyword = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#accountList tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(keyword) ? '' : 'none';
    });
});

// 添加公众号
function submitAddAccount() {
    const name = document.getElementById('accountName').value.trim();
    const alias = document.getElementById('accountAlias').value.trim();
    
    if (!name) {
        showError('请输入公众号名称');
        return;
    }
    
    showLoading('正在添加公众号...');
    
    axios.post('/api/wechat/add', { name, alias })
        .then(response => {
            hideLoading();
            if (response.data.code === 200) {
                showSuccess('添加成功');
                setTimeout(() => location.reload(), 1000);
            } else {
                showError(response.data.msg || '添加失败');
            }
        })
        .catch(error => {
            hideLoading();
            showError('请求失败: ' + error.message);
        });
}

// 查看公众号详情
function viewAccount(id) {
    window.location.href = '/admin/accounts/' + id;
}

// 删除公众号
function deleteAccount(id, name) {
    if (!confirm(`确定要删除公众号"${name}"吗？\n删除后该公众号的所有文章记录将保留。`)) {
        return;
    }
    
    showLoading('正在删除...');
    
    axios.delete('/api/wechat/' + id)
        .then(response => {
            hideLoading();
            if (response.data.code === 200) {
                showSuccess('删除成功');
                setTimeout(() => location.reload(), 1000);
            } else {
                showError(response.data.msg || '删除失败');
            }
        })
        .catch(error => {
            hideLoading();
            showError('请求失败: ' + error.message);
        });
}
</script>
</div>

{{template "footer" .}}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/static/js/admin.js?v=1.0.0"></script>
</body>
</html>
{{end}}


